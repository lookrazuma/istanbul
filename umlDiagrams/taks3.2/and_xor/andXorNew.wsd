@startuml

start
:Клиент заходит на сайт;
if (Клиент зарегистрирован?) then (да)
    :Клиент вводит учетные данные;
    :Система проверяет учетные данные;
    if (Данные валидны) then (да)
        :Система перенаправляет клиента в каталог;
    else (нет)
        :Предложить пользователю зарегистрироваться или сбросить пароль;
        if (Пользователь выбрал перейти на регистрацию?) then (да)
            :Отобразить страницу регистрации;
            :Клиент регистрируется;
        else (нет)
            repeat
                if (Пользователь хочет восстановить пароль?) then (нет)
                    :Выходит со страницы;
                    stop
                    
                end if
                :Пользователь вводит email/номер телефона;
                :Система направляет код сброса пароля;
            repeat while (прошло 180 секунд и клиент \n 3 раза ввел неправильный код?) is (да) not (нет)
            
        end if
    end if
else
    :Клиент регистрируется;
end if

:Клиент выбирает товары;
:Клиент добавляет товары в корзину;
:Клиент переходит к оформлению заказа;
if (Клиент вводит промокод?) then (да)
    :Клиент вводит промокод;
else (нет)
    :Система автоматически применяет скидку;
endif

:Система проверяет условия использования скидки;

if (Условия удовлетворены?) then (да)
    :Обновление суммы заказа с учётом скидки;
else (нет)
    if (Неверный промокод?) then (да)
        :Уведомление клиента о неверном промокоде;
    else (нет)
        if (Превышение лимита на использование промокода?) then (да)
            :Уведомление клиента о превышении лимита;
        else (нет)
            :Уведомление клиента о том, что промокод не действует на выбранные товары;
        endif
    endif
endif
:Клиент выбирает способ доставки и оплаты;

if (Клиент выбирает ПВЗ?) then (да)
    :Клиент выбирает пункт выдачи;
    :Система подтверждает выбор ПВЗ;
    :Клиент выбирает способ оплаты для ПВЗ;
    if (Клиент выбирает Оплатить сейчас?) then (да)
        :Клиент выбирает карту для оплаты;
        :Система проверяет привязанную карту;
        if (Карта привязана?) then (да)
            :Система подтверждает выбор способа оплаты;
        else (нет)
            :Система предлагает привязать карту;
            :Клиент привязывает карту;
            :Система подтверждает выбор способа оплаты;
        endif
    else (нет)
        if (Клиент выбирает Оплатить наличными в ПВЗ?) then (да)
            :Система подтверждает выбор наличных;
        else (нет)
            if (Клиент выбирает Оплатить по частям?) then (да)
                :Система предлагает условия оплаты по частям;
                :Клиент соглашается с условиями;
                :Система подтверждает выбор оплаты по частям;
            else (нет)
                :Клиент выбирает Списать после получения;
                :Система подтверждает выбор списания после получения;
            endif
        endif
    endif
else (нет)
    if (Клиент выбирает Пункт выдачи партнера?) then (да)
        :Клиент выбирает пункт выдачи партнера;
        :Система подтверждает выбор пункта выдачи партнера;
        :Клиент выбирает способ оплаты для предоплаты или по частям;
        if (Клиент выбирает Предоплата?) then (да)
            :Клиент выбирает карту для оплаты;
            :Система проверяет привязанную карту;
            if (Карта привязана?) then (да)
                :Система подтверждает выбор способа оплаты;
            else (нет)
                :Система предлагает привязать карту;
                :Клиент привязывает карту;
                :Система подтверждает выбор способа оплаты;
            endif
        else (нет)
            :Клиент выбирает Оплатить по частям;
            :Система предлагает условия оплаты по частям;
            :Клиент соглашается с условиями;
            :Система подтверждает выбор оплаты по частям;
        endif
    else (нет)
        if (Клиент выбирает Самовывоз из магазина?) then (да)
            :Клиент выбирает магазин для самовывоза;
            :Система подтверждает выбор магазина;
            :Клиент выбирает способ оплаты для предоплаты или по частям;
            if (Клиент выбирает Предоплата?) then (да)
                :Клиент выбирает карту для оплаты;
                :Система проверяет привязанную карту;
                if (Карта привязана?) then (да)
                    :Система подтверждает выбор предоплаты;
                else (нет)
                    :Система предлагает привязать карту;
                    :Клиент привязывает карту;
                    :Система подтверждает выбор предоплаты;
                endif
            else (нет)
                :Клиент выбирает Оплатить по частям;
                :Система предлагает условия оплаты по частям;
                :Клиент соглашается с условиями;
                :Система подтверждает выбор оплаты по частям;
            endif
        else (нет)
            :Клиент выбирает Доставку на дом;
            :Клиент заполняет адрес доставки;
            :Система валидирует адрес доставки;
            :Система рассчитывает сроки доставки;
            :Система подтверждает сроки доставки;
            :Клиент выбирает способ оплаты для предоплаты или по частям;
            if (Клиент выбирает Предоплата?) then (да)
                :Клиент выбирает карту для оплаты;
                :Система проверяет привязанную карту;
                if (Карта привязана?) then (да)
                    :Система подтверждает выбор предоплаты;
                else (нет)
                    :Система предлагает привязать карту;
                    :Клиент привязывает карту;
                    :Система подтверждает выбор предоплаты;
                endif
            else (нет)
                :Клиент выбирает Оплатить по частям;
                :Система предлагает условия оплаты по частям;
                :Клиент соглашается с условиями;
                :Система подтверждает выбор оплаты по частям;
            endif
        endif
    endif
endif

:Проверка наличия товара на складе;
:Система проверяет наличие каждого товара в выбранных количествах;

if (Товары доступны?) then (да)
    fork
        :Оплата заказа;
        :Система проверяет платёжные детали;
        :Система производит транзакцию;
        if (Оплата успешна?) then (да)
            :Генерируется счёт-фактура;
            :Отправляется уведомление клиенту о подтверждении заказа;
            :Отправляется уведомление клиенту о статусе доставки;
            :Заказ переходит в статус «Отправлен»;
        else (нет)
            :Отправляется уведомление клиента о проблеме с платежом;
            :Предложение повторить попытку оплаты;
            :Предложение изменить способ оплаты;
            if (Клиент согласен отменить заказ?) then (да)
                :Заказ отменяется;
                :Клиенту возвращаются средства (если были списаны);
            endif
        endif
    fork again
        :Подготовка товара к отправке;
        :Система уведомляет склад о необходимости собрать заказ;
        :Сотрудники склада комплектуют заказ по списку;
    end fork
else (нет)
    :Уведомление клиента о недоступности товара;
    :Предложение выбрать альтернативный товар;
    :Удаление отсутствующего товара из заказа;
    :Продолжить оформление заказа;
endif

:Отслеживание и доставка заказа;
:Система обновляет статус заказа по мере его продвижения к доставке;
:Клиент получает уведомления о каждом изменении статуса;

stop

@enduml
